from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes
import sqlite3
from datetime import datetime
import os
import logging

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾Ğ³Ğ³ĞµÑ€Ğ°
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ· Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')  # Ğ¢Ğ¾ĞºĞµĞ½ Telegram-Ğ±Ğ¾Ñ‚Ğ°

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸
def get_statistics(start_date=None, end_date=None, offer_id=None, pp_name=None):
    conn = sqlite3.connect('conversions.db')
    cursor = conn.cursor()

    query = '''
        SELECT pp_name, offer_id, SUM(revenue), COUNT(*)
        FROM conversions
        WHERE 1=1
    '''
    params = []

    if start_date:
        query += ' AND conversion_date >= ?'
        params.append(start_date)
    if end_date:
        query += ' AND conversion_date <= ?'
        params.append(end_date)
    if offer_id:
        query += ' AND offer_id = ?'
        params.append(offer_id)
    if pp_name:
        query += ' AND pp_name = ?'
        params.append(pp_name)

    query += ' GROUP BY pp_name, offer_id'
    cursor.execute(query, params)
    results = cursor.fetchall()
    conn.close()

    return results

# ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ·Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ", callback_data='stats_today')],
        [InlineKeyboardButton("Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ·Ğ° Ğ¼ĞµÑÑÑ†", callback_data='stats_month')],
        [InlineKeyboardButton("ĞÑ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ", callback_data='mute')],
        [InlineKeyboardButton("Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ", callback_data='unmute')],
        [InlineKeyboardButton("ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ", callback_data='help')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:", reply_markup=reply_markup)

# ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° callback-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    if query.data == 'stats_today':
        today = datetime.now().strftime('%Y-%m-%d')
        stats_data = get_statistics(start_date=today)
        message = format_stats_message(stats_data, "Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ·Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ")
    elif query.data == 'stats_month':
        first_day_of_month = datetime.now().replace(day=1).strftime('%Y-%m-%d')
        stats_data = get_statistics(start_date=first_day_of_month)
        message = format_stats_message(stats_data, "Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ·Ğ° Ğ¼ĞµÑÑÑ†")
    elif query.data == 'mute':
        message = "ğŸ”• Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ñ‹."
    elif query.data == 'unmute':
        message = "ğŸ”” Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ñ‹."
    elif query.data == 'help':
        message = (
            "ğŸ“‹ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´:\n"
            "/start - ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ Ñ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼\n"
            "/stats - ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ\n"
            "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ñ… Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹."
        )

    await query.edit_message_text(text=message, parse_mode='HTML')

# Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ ÑĞ¾ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¾Ğ¹
def format_stats_message(stats_data, title):
    if not stats_data:
        return f"ğŸ“Š {title}:\n\nĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…."

    message = f"ğŸ“Š {title}:\n\n"
    for row in stats_data:
        pp_name, offer_id, total_revenue, total_conversions = row
        message += (
            f"ğŸ“Œ ĞŸĞ°Ñ€Ñ‚Ğ½Ñ‘Ñ€ÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°: <i>{pp_name}</i>\n"
            f"ğŸ“Œ ĞÑ„Ñ„ĞµÑ€: <i>{offer_id}</i>\n"
            f"ğŸ¤‘ ĞĞ±Ñ‰Ğ°Ñ Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ğ°: <i>{total_revenue}</i>\n"
            f"ğŸ“Š ĞšĞ¾Ğ½Ğ²ĞµÑ€ÑĞ¸Ğ¹: <i>{total_conversions}</i>\n\n"
        )
    return message

# Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ°
if __name__ == '__main__':
    application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CallbackQueryHandler(button_handler))
    application.run_polling()
